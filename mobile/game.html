<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T-16: Quantum Protocol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –≤–∏–¥–∞ */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #0d0d1a;
            color: #c0c0ff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        
        #game-container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            box-sizing: border-box;
            background-color: #1a1a33;
            border-radius: 12px;
            margin-top: 10px;
            border: 1px solid #464687;
            box-shadow: 0 4px 15px rgba(70, 70, 150, 0.7);
        }
        
        h1 {
            color: #7aff7a;
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 10px;
            font-weight: 900;
        }
        
        #story-text-content {
            background-color: #26264d;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            line-height: 1.5;
            white-space: pre-wrap;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.6);
            border: 1px solid #333366;
            overflow-y: auto;
        }
        
        .action-button {
            transition: all 0.2s ease-in-out;
            transform: scale(1);
        }
        
        .action-button:hover:not(:disabled) {
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(0, 136, 204, 0.5);
        }
        
        .action-button:disabled {
            background-color: #464687 !important;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫ */
        #game-mechanic {
            background-color: #333366;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            box-shadow: 0 0 10px rgba(255, 192, 77, 0.4);
        }
        
        .mechanic-title {
            color: #ffc04d;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
            text-shadow: 0 0 5px rgba(255, 192, 77, 0.6);
        }
        
        .emoji-button {
            font-size: 1.5em;
            padding: 15px;
            background-color: #464687;
            border: 2px solid #5a5a9a;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .emoji-button:hover:not(:disabled) {
            background-color: #5a5a9a;
        }
        
        /* –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è */
        .progress-bar {
            height: 20px;
            background-color: #464687;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.4);
        }
        
        .progress-fill {
            height: 100%;
            width: 0%;
            background-color: #ffc04d;
            transition: width 0.3s ease;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ */
        #achievement-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #7aff7a;
            color: #1a1a33;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(122, 255, 122, 0.8);
            font-weight: bold;
            display: none;
            z-index: 2000;
            animation: fadeInOut 5s forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(100px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(100px); }
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –°—Ç–∞–¥–∏–∏ */
        #stage-indicator {
            background-color: #333366;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            color: #00ffaa;
            border: 1px solid #00aa77;
            box-shadow: 0 0 8px rgba(0, 255, 170, 0.3);
        }
    </style>
</head>
<body class="selection:bg-teal-700 selection:text-white">
    <div id="game-container">
        <h1>T-16: Quantum Protocol</h1>
        
        <div class="flex justify-between items-center mb-4 text-sm">
            <p class="text-yellow-400">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="current-part"></span> / 31</p>
            <div id="stage-indicator">–°—Ç–∞–¥–∏—è T-16: <span id="current-stage">1.0</span></div>
            <button onclick="toggleAchievements()" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 rounded-md transition duration-150 text-xs">
                –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            </button>
        </div>
        
        <div id="chiksometr-log-container" class="mt-4 p-3 bg-red-900 bg-opacity-30 border border-red-700 rounded-lg hidden">
            <p class="text-sm font-bold text-red-400">–°–ï–ö–†–ï–¢–ù–´–ô –ü–†–û–¢–û–ö–û–õ –§–û–ù–î–ê (–ß–∏–∫—Å–æ–º–µ—Ç—Ä):</p>
            <p id="chiksometr-log-text" class="text-xs italic text-red-200 mt-1"></p>
        </div>
        <div id="story-view">
            <div id="story-text-content" class="text-gray-200"></div>
        </div>

        <div id="game-mechanic" class="shadow-lg hidden">
            <div class="mechanic-title" id="mechanic-title"></div>

            <div id="loading-mechanic-container" class="hidden">
                <p class="mb-3 text-lg font-bold text-teal-400">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è INO-PC: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –°–∏—Å—Ç–µ–º...</p>
                <div class="progress-bar">
                    <div id="loading-progress-fill" class="progress-fill bg-teal-500"></div>
                </div>
            </div>

            <div id="emoji-hack-container" class="hidden">
                <p class="mb-3 text-sm">–°–æ–ø–æ—Å—Ç–∞–≤—å—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Å–∏–º–≤–æ–ª. –¶–µ–ª—å: <span id="emoji-required-count" class="font-bold text-red-400"></span></p>
                <div id="challenge-target" class="text-5xl my-4 text-green-400 font-extrabold"></div>
                <div class="grid grid-cols-3 gap-3" id="emoji-options"></div>
            </div>

            <div id="math-hack-container" class="hidden">
                <p class="mb-3 text-sm">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã. –¶–µ–ª—å: <span id="math-required-count" class="font-bold text-red-400"></span></p>
                <div id="math-problem" class="text-2xl my-4 text-green-400 font-extrabold"></div>
                <input type="number" id="math-answer" placeholder="–û—Ç–≤–µ—Ç" class="w-full p-3 bg-gray-700 text-white rounded-lg border-none focus:ring-2 focus:ring-yellow-500">
                <button class="action-button w-full mt-3 bg-yellow-600 hover:bg-yellow-700" onclick="submitMathAnswer()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>
            
            <div id="coordinate-hack-container" class="hidden">
                <p class="mb-4 text-sm text-red-300">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏.</p>
                <input type="number" id="coordinate-input" placeholder="–ö–æ–¥-–ø–∞—Ä–æ–ª—å" class="w-full p-3 bg-gray-700 text-white rounded-lg border-none focus:ring-2 focus:ring-yellow-500">
                <button class="action-button w-full mt-3 bg-yellow-600 hover:bg-yellow-700" onclick="submitCoordinateHack()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </div>

            <div id="sequence-hack-container" class="hidden">
                <p class="mb-3 text-sm">–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç—Ä–µ–ª–æ–∫ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏–ª–∏ –∫–Ω–æ–ø–∫–∏). –¶–µ–ª—å: <span id="sequence-required-count" class="font-bold text-red-400"></span></p>
                <div id="sequence-display" class="text-4xl my-4 text-yellow-400 font-extrabold flex justify-center space-x-3 h-12 items-center">?</div>
                <div id="sequence-buttons" class="grid grid-cols-4 gap-2">
                    <button class="action-button bg-gray-700 text-white p-3 rounded-md" data-key="ArrowUp">‚¨ÜÔ∏è</button>
                    <button class="action-button bg-gray-700 text-white p-3 rounded-md" data-key="ArrowDown">‚¨áÔ∏è</button>
                    <button class="action-button bg-gray-700 text-white p-3 rounded-md" data-key="ArrowLeft">‚¨ÖÔ∏è</button>
                    <button class="action-button bg-gray-700 text-white p-3 rounded-md" data-key="ArrowRight">‚û°Ô∏è</button>
                </div>
            </div>

            <div id="filter-hack-container" class="hidden">
                <p class="mb-3 text-sm">–û—Ç—Ñ–∏–ª—å—Ç—Ä—É–π—Ç–µ "–ß–∏—Å—Ç—ã–π –°–∏–≥–Ω–∞–ª" (—Ç–æ—Ç, —á—Ç–æ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ä–µ–∂–µ –≤—Å–µ–≥–æ). –¶–µ–ª—å: <span id="filter-required-count" class="font-bold text-red-400"></span></p>
                <div id="filter-options" class="grid grid-cols-3 gap-3"></div>
            </div>
        </div>

        <button id="next-button" class="action-button w-full mt-5 bg-blue-600 text-white hover:bg-blue-700" onclick="handleNextClick()">–î–∞–ª–µ–µ</button>
        
        <button id="reset-button" class="action-button w-full mt-3 bg-red-600 text-white hover:bg-red-700" onclick="resetGame()">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>

    <div id="achievement-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center z-30">
        <div class="bg-indigo-900 p-6 rounded-lg shadow-2xl w-11/12 max-w-md border border-indigo-700">
            <h2 class="text-2xl font-bold text-yellow-400 mb-4 border-b pb-2 border-indigo-700">–ü—Ä–æ—Ç–æ–∫–æ–ª—ã –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π</h2>
            <div id="achievement-list" class="h-64 overflow-y-auto"></div>
            <button class="action-button w-full mt-4 bg-indigo-600 hover:bg-indigo-700" onclick="toggleAchievements()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="achievement-notification"></div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–°–¢–û–†–ò–ò –ò –î–û–°–¢–ò–ñ–ï–ù–ò–ô ===
        const EMOJIS = ['üöÄ', 'üíª', 'üîÆ', 'ü¶†', 'üí•', 'üîë', '‚ö°', 'ü§ñ', 'üõ∞Ô∏è', 'üî•', '‚öôÔ∏è', 'üßä'];
        const SEQUENCE_EMOJIS = { 'ArrowUp': '‚¨ÜÔ∏è', 'ArrowDown': '‚¨áÔ∏è', 'ArrowLeft': '‚¨ÖÔ∏è', 'ArrowRight': '‚û°Ô∏è' };
        let storyData = []; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—é–∂–µ—Ç–∞

        const ACHIEVEMENTS = {
            'first_hack': { title: '–ü–µ—Ä–≤—ã–π –í–∑–ª–æ–º', description: '–£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏—Ä—É—Å-–∑–∞–≥–ª—É—à–∫—É –≤ INO-PC.', part: 3 },
            'fire_starter': { title: '–° –ø—ã–ª—É, —Å –∂–∞—Ä—É!', description: '–í—ã–∑–≤–∞—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–º–∞–≥–Ω–∏—Ç–Ω—ã–π –∏–º–ø—É–ª—å—Å –∏ –ø–æ–∂–∞—Ä –≤ –•–∞—Ä–∏–Ω–æ.', part: 6 },
            'repair_expert': { title: '–ù–∞–Ω–æ-–ú–∞—Å—Ç–µ—Ä', description: '–£—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é —Ä—É–∫—É.', part: 14 },
            'cooldown': { title: '–•–æ–ª–æ–¥–Ω–æ–µ –Ø–¥—Ä–æ', description: '–£—Å–ø–µ—à–Ω—ã–π —Ç—Ä–∞–Ω–∑–∏—Ç –≤ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–æ–º –≤–∞–≥–æ–Ω–µ.', part: 20 },
            'quantum_jump': { title: '–ö–≤–∞–Ω—Ç–æ–≤—ã–π –ü—Ä—ã–∂–æ–∫', description: '–î–æ—Å—Ç–∏–≥–Ω—É—Ç—å —Ñ–∏–Ω–∞–ª–∞ –∏—Å—Ç–æ—Ä–∏–∏ (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ –¥—Ä—É–≥—É—é —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å).', part: 31 }
        };

        // --- –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò –°–Æ–ñ–ï–¢–ê –ò–ó JSON ---
        async function loadStoryData() {
            try {
                const response = await fetch('story_data.json');
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—é–∂–µ—Ç–∞: ${response.statusText}`);
                }
                storyData = await response.json();
                console.log("–°—é–∂–µ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω.");
            } catch (error) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—é–∂–µ—Ç–∞:", error);
                document.getElementById('story-text-content').innerHTML = `
                    <p class="text-red-500 font-bold">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê:</p>
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å—é–∂–µ—Ç–∞ (story_data.json). –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ.</p>
                `;
                document.getElementById('next-button').disabled = true;
                throw error;
            }
        }
        
        // === –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ===
        let gameState = {
            currentPart: 1,
            currentStage: 1.0,
            currentAchievement: 0,
            achievements: {},
            mechanicActive: false,
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫–∏ Loading Pause
            loadingTimer: null,
            loadingDuration: 0,
            loadingStartTime: 0,
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫–∏ Emoji Hack
            emojiTarget: '',
            emojiRequired: 0,
            emojiCurrent: 0,
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫–∏ Math Hack
            mathAnswer: 0,
            mathRequired: 0,
            mathCurrent: 0,
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫–∏ Sequence Hack (–ù–û–í–´–ï)
            sequenceGoal: [],
            sequencePlayer: [],
            sequenceRequired: 0,
            sequenceCurrent: 0,
            sequenceListenerActive: false,
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–µ—Ö–∞–Ω–∏–∫–∏ Filter Hack (–ù–û–í–´–ï)
            filterTargetEmoji: '',
            filterRequired: 0,
            filterCurrent: 0,
        };

        // === –°–õ–£–ñ–ï–ë–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        function saveGameState() {
            localStorage.setItem('t16_gameState', JSON.stringify(gameState));
            localStorage.setItem('t16_achievements', JSON.stringify(gameState.achievements));
        }

        function loadGameState() {
            const savedState = localStorage.getItem('t16_gameState');
            const savedAchievements = localStorage.getItem('t16_achievements');
            if (savedState) {
                gameState = JSON.parse(savedState);
            }
            if (savedAchievements) {
                gameState.achievements = JSON.parse(savedAchievements);
            }
            // –ì–∞—Ä–∞–Ω—Ç–∏—è, —á—Ç–æ –∏–≥—Ä–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–µ—Ä–≤–æ–π —á–∞—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
            if (gameState.currentPart > storyData.length) {
                 gameState.currentPart = 1;
            }
            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            gameState.mechanicActive = false;
        }

        function resetGame() {
            if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞–Ω–æ–≤–æ? –ü—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.")) {
                localStorage.removeItem('t16_gameState');
                localStorage.removeItem('t16_achievements');
                gameState = {
                    currentPart: 1,
                    currentStage: 1.0,
                    currentAchievement: 0,
                    achievements: {},
                    mechanicActive: false,
                    loadingTimer: null,
                    loadingDuration: 0,
                    loadingStartTime: 0,
                    emojiTarget: '',
                    emojiRequired: 0,
                    emojiCurrent: 0,
                    mathAnswer: 0,
                    mathRequired: 0,
                    mathCurrent: 0,
                    sequenceGoal: [],
                    sequencePlayer: [],
                    sequenceRequired: 0,
                    sequenceCurrent: 0,
                    sequenceListenerActive: false,
                    filterTargetEmoji: '',
                    filterRequired: 0,
                    filterCurrent: 0,
                };
                // –£–¥–∞–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø—Ä–∏ —Å–±—Ä–æ—Å–µ
                document.removeEventListener('keydown', handleSequenceInput);
                gameState.sequenceListenerActive = false;

                displayStoryPart(gameState.currentPart);
                updateUI();
                showAchievementNotification("–ü—Ä–æ—Ç–æ–∫–æ–ª —Å–±—Ä–æ—à–µ–Ω. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.");
            }
        }

        function updateUI() {
            document.getElementById('current-part').textContent = gameState.currentPart;
            document.getElementById('current-stage').textContent = gameState.currentStage.toFixed(1);
            
            const currentPartData = storyData.find(p => p.part === gameState.currentPart);

            if (!currentPartData) {
                document.getElementById('next-button').textContent = '–ö–æ–Ω–µ—Ü –ü—Ä–æ—Ç–æ–∫–æ–ª–∞';
                document.getElementById('next-button').disabled = true;
                return;
            }

            if (gameState.mechanicActive) {
                document.getElementById('next-button').textContent = '–í–∑–ª–æ–º –ê–∫—Ç–∏–≤–µ–Ω...';
                document.getElementById('next-button').disabled = true;
                document.getElementById('game-mechanic').classList.remove('hidden');
            } else if (currentPartData.action === 'hack') {
                document.getElementById('next-button').textContent = '–ù–∞—á–∞—Ç—å –í–∑–ª–æ–º';
                document.getElementById('next-button').disabled = false;
                document.getElementById('game-mechanic').classList.remove('hidden');
            } else if (currentPartData.action === 'finish') {
                document.getElementById('next-button').textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å –ü—Ä–æ—Ç–æ–∫–æ–ª';
                document.getElementById('next-button').disabled = false;
                document.getElementById('game-mechanic').classList.add('hidden');
            } else {
                document.getElementById('next-button').textContent = '–î–∞–ª–µ–µ';
                document.getElementById('next-button').disabled = false;
                document.getElementById('game-mechanic').classList.add('hidden');
            }
        }

        function displayStoryPart(partNumber) {
            const currentPartData = storyData.find(p => p.part === partNumber);
            if (!currentPartData) return;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            gameState.currentPart = partNumber;
            gameState.currentStage += currentPartData.stageChange;

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.getElementById('story-text-content').innerHTML = `
                <h2 class="font-bold text-lg text-teal-400 mb-2">${currentPartData.part}. ${currentPartData.title}</h2>
                <p>${currentPartData.text}</p>
            `;

            // --- –õ–æ–≥–∏–∫–∞ –ß–∏–∫—Å–æ–º–µ—Ç—Ä–∞ ---
            const logContainer = document.getElementById('chiksometr-log-container');
            const logText = document.getElementById('chiksometr-log-text');
            if (currentPartData.agent_log) {
                logText.innerHTML = currentPartData.agent_log;
                logContainer.classList.remove('hidden');
            } else {
                logContainer.classList.add('hidden');
                logText.innerHTML = '';
            }
            // --- –ö–æ–Ω–µ—Ü –õ–æ–≥–∏–∫–∏ –ß–∏–∫—Å–æ–º–µ—Ç—Ä–∞ ---


            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
            if (currentPartData.achievement) {
                unlockAchievement(currentPartData.achievement);
            }

            // –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö –º–µ—Ö–∞–Ω–∏–∫
            document.getElementById('loading-mechanic-container').classList.add('hidden');
            document.getElementById('emoji-hack-container').classList.add('hidden');
            document.getElementById('math-hack-container').classList.add('hidden');
            document.getElementById('coordinate-hack-container').classList.add('hidden');
            document.getElementById('sequence-hack-container').classList.add('hidden');
            document.getElementById('filter-hack-container').classList.add('hidden');


            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–µ—Ö–∞–Ω–∏–∫–µ, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
            if (currentPartData.action === 'hack') {
                document.getElementById('mechanic-title').textContent = `–ó–∞–ø—É—Å–∫: ${currentPartData.title}`;
            } else {
                document.getElementById('game-mechanic').classList.add('hidden');
            }
            
            saveGameState();
            updateUI();
        }

        function handleNextClick() {
            const currentPartData = storyData.find(p => p.part === gameState.currentPart);
            if (!currentPartData) return;

            if (gameState.mechanicActive) return;

            if (currentPartData.action === 'hack') {
                // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ "–ù–∞—á–∞—Ç—å –í–∑–ª–æ–º", –∑–∞–ø—É—Å–∫–∞–µ–º –º–µ—Ö–∞–Ω–∏–∫—É
                startMechanic(currentPartData.mechanic, currentPartData.difficulty, currentPartData.duration);
            } else if (currentPartData.action === 'next' && gameState.currentPart < storyData.length) {
                displayStoryPart(gameState.currentPart + 1);
            } else if (currentPartData.action === 'finish') {
                updateUI();
                // –§–∏–Ω–∞–ª—å–Ω—ã–π —Ç–≤–∏—Å—Ç –æ—Ç –ß–∏–∫—Å–æ–º–µ—Ç—Ä–∞
                if (currentPartData.agent_log) {
                    showAchievementNotification(currentPartData.agent_log.replace('–ß–∏–∫—Å–æ–º–µ—Ç—Ä: ', '–§–ò–ù–ê–õ–¨–ù–´–ô –ü–†–û–¢–û–ö–û–õ: '));
                } else {
                    showAchievementNotification("–ò—Å—Ç–æ—Ä–∏—è –ü—Ä–æ—Ç–æ–∫–æ–ª–∞ –¢-16 –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
                }
            }
        }

        // === –õ–û–ì–ò–ö–ê –î–û–°–¢–ò–ñ–ï–ù–ò–ô ===
        function unlockAchievement(key) {
            if (!gameState.achievements[key]) {
                gameState.achievements[key] = true;
                gameState.currentAchievement++;
                showAchievementNotification(`–î–û–°–¢–ò–ñ–ï–ù–ò–ï: ${ACHIEVEMENTS[key].title}`);
                saveGameState();
            }
        }

        function toggleAchievements() {
            const modal = document.getElementById('achievement-modal');
            const list = document.getElementById('achievement-list');
            list.innerHTML = '';
            Object.keys(ACHIEVEMENTS).forEach(key => {
                const achievement = ACHIEVEMENTS[key];
                const unlocked = gameState.achievements[key];
                const item = document.createElement('div');
                item.className = `p-3 mb-2 rounded-lg ${unlocked ? 'bg-green-700' : 'bg-gray-700'} transition duration-200 ease-in-out`;
                item.innerHTML = `
                    <p class="font-bold text-lg ${unlocked ? 'text-white' : 'text-gray-400'}">${unlocked ? '‚úÖ ' : 'üîí '} ${achievement.title}</p>
                    <p class="text-sm ${unlocked ? 'text-gray-100' : 'text-gray-500'}">${achievement.description}</p>
                `;
                list.appendChild(item);
            });
            modal.classList.toggle('hidden');
        }

        function showAchievementNotification(message) {
            const notification = document.getElementById('achievement-notification');
            notification.textContent = message;
            // –°–±—Ä–æ—Å –∞–Ω–∏–º–∞—Ü–∏–∏
            notification.style.animation = 'none';
            notification.offsetHeight; /* trigger reflow */
            notification.style.animation = null; 
            
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // === –õ–û–ì–ò–ö–ê –ú–ï–•–ê–ù–ò–ö –í–ó–õ–û–ú–ê ===

        function startMechanic(mechanicType, difficulty, duration) {
            gameState.mechanicActive = true;
            document.getElementById('next-button').textContent = '–í–∑–ª–æ–º –ê–∫—Ç–∏–≤–µ–Ω...';
            document.getElementById('next-button').disabled = true;

            if (mechanicType === 'loading_pause') {
                document.getElementById('mechanic-title').textContent = '–ü—Ä–æ—Ç–æ–∫–æ–ª INO-PC: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –°–∏—Å—Ç–µ–º';
                startLoadingPause(duration || 5000);
            } else if (mechanicType === 'emoji') {
                document.getElementById('mechanic-title').textContent = '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ü—Ä–æ—Ç–æ–∫–æ–ª: –ö–≤–∞–Ω—Ç–æ–≤—ã–π –®—É–º';
                startEmojiHack(difficulty || 3);
            } else if (mechanicType === 'math') {
                document.getElementById('mechanic-title').textContent = '–ù–µ–π—Ä–æ-–ú–∞—Ç—Ä–∏—Ü–∞: –†–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è';
                startMathHack(difficulty || 3);
            } else if (mechanicType === 'coordinate') {
                document.getElementById('mechanic-title').textContent = '–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä: –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ß–∞—Å—Ç–æ—Ç—ã';
                startCoordinateHack();
            } else if (mechanicType === 'sequence') {
                document.getElementById('mechanic-title').textContent = '–°–≤–µ—Ä—Ö—Å–∫–æ—Ä–æ—Å—Ç–Ω–æ–π –ü—Ä–æ—Ç–æ–∫–æ–ª: –ú–æ—Ç–æ—Ä–Ω—ã–π –†–µ—Ñ–ª–µ–∫—Å';
                startSequenceHack(difficulty || 3);
            } else if (mechanicType === 'filter') {
                document.getElementById('mechanic-title').textContent = '–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ß–∞—Å—Ç–æ—Ç–∞: –ò–∑–æ–ª—è—Ü–∏—è –°–∏–≥–Ω–∞–ª–∞';
                startFilterHack(difficulty || 3);
            }
            updateUI();
        }

        function finishMechanic(mechanicType, success) {
            gameState.mechanicActive = false;
            
            // –°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∞
            if (mechanicType === 'loading_pause' && gameState.loadingTimer) {
                clearInterval(gameState.loadingTimer);
                document.getElementById('loading-progress-fill').style.width = '100%';
                setTimeout(() => {
                    document.getElementById('loading-mechanic-container').classList.add('hidden');
                }, 500);
            }

            // –°–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–µ—Ö–∞–Ω–∏–∫–∏
            document.getElementById('game-mechanic').classList.add('hidden');
            document.getElementById('sequence-hack-container').classList.add('hidden'); // –°–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

            if (success) {
                showAchievementNotification("–í–∑–ª–æ–º –£–°–ü–ï–®–ï–ù. –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ü—Ä–æ—Ç–æ–∫–æ–ª—É.");
                displayStoryPart(gameState.currentPart + 1);
            } else {
                showAchievementNotification("–°–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
                // –õ–æ–≥–∏–∫–∞ —Å–±—Ä–æ—Å–∞ —É–∂–µ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–µ—Ö–∞–Ω–∏–∫–∏
                updateUI();
            }
        }

        // --- 1. Loading Pause ---
        function startLoadingPause(duration) {
            document.getElementById('loading-mechanic-container').classList.remove('hidden');
            document.getElementById('loading-progress-fill').style.width = '0%';
            gameState.loadingDuration = duration;
            gameState.loadingStartTime = Date.now();
            if (gameState.loadingTimer) clearInterval(gameState.loadingTimer);
            gameState.loadingTimer = setInterval(() => {
                const elapsed = Date.now() - gameState.loadingStartTime;
                const percent = (elapsed / gameState.loadingDuration) * 100;
                document.getElementById('loading-progress-fill').style.width = `${Math.min(100, percent)}%`;
                if (elapsed >= gameState.loadingDuration) {
                    finishMechanic('loading_pause', true);
                }
            }, 100);
        }

        // --- 2. Emoji Hack ---
        function startEmojiHack(difficulty) {
            document.getElementById('emoji-hack-container').classList.remove('hidden');
            gameState.emojiRequired = difficulty;
            gameState.emojiCurrent = 0;
            document.getElementById('emoji-required-count').textContent = `${gameState.emojiCurrent} / ${gameState.emojiRequired}`;
            generateEmojiChallenge();
        }

        function generateEmojiChallenge() {
            // –í—ã–±–æ—Ä —Ü–µ–ª–µ–≤–æ–≥–æ —ç–º–æ–¥–∑–∏
            const targetEmoji = EMOJIS[Math.floor(Math.random() * EMOJIS.length)];
            gameState.emojiTarget = targetEmoji;
            document.getElementById('challenge-target').textContent = targetEmoji;

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø—Ü–∏–π (6 –∫–Ω–æ–ø–æ–∫, –æ–¥–Ω–∞ –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö - —Ü–µ–ª–µ–≤–∞—è)
            const optionsContainer = document.getElementById('emoji-options');
            optionsContainer.innerHTML = '';
            
            const options = new Set();
            options.add(targetEmoji);

            while (options.size < 6) {
                options.add(EMOJIS[Math.floor(Math.random() * EMOJIS.length)]);
            }

            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Set –≤ –º–∞—Å—Å–∏–≤ –∏ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏–µ
            let shuffledOptions = Array.from(options).sort(() => 0.5 - Math.random());

            shuffledOptions.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'emoji-button';
                button.textContent = emoji;
                button.onclick = () => handleEmojiClick(emoji);
                optionsContainer.appendChild(button);
            });
        }

        function handleEmojiClick(emoji) {
            if (!gameState.mechanicActive) return;

            if (emoji === gameState.emojiTarget) {
                gameState.emojiCurrent++;
                showAchievementNotification("–°–æ–≤–ø–∞–¥–µ–Ω–∏–µ! –ü—Ä–æ–≥—Ä–µ—Å—Å +1.");
                if (gameState.emojiCurrent >= gameState.emojiRequired) {
                    finishMechanic('emoji', true);
                } else {
                    document.getElementById('emoji-required-count').textContent = `${gameState.emojiCurrent} / ${gameState.emojiRequired}`;
                    generateEmojiChallenge(); // –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
                }
            } else {
                showAchievementNotification("–°–±–æ–π. –ü–æ—Ç–µ—Ä—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.");
                // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —Ä–∞—É–Ω–¥–µ
                gameState.emojiCurrent = 0;
                document.getElementById('emoji-required-count').textContent = `${gameState.emojiCurrent} / ${gameState.emojiRequired}`;
                generateEmojiChallenge();
            }
        }

        // --- 3. Math Hack ---
        function startMathHack(difficulty) {
            document.getElementById('math-hack-container').classList.remove('hidden');
            gameState.mathRequired = difficulty;
            gameState.mathCurrent = 0;
            document.getElementById('math-required-count').textContent = `${gameState.mathCurrent} / ${gameState.mathRequired}`;
            document.getElementById('math-answer').value = '';
            generateMathProblem();
        }

        function generateMathProblem() {
            let a, b, operator, problem;
            let correctAnswer;
            const currentPartData = storyData.find(p => p.part === gameState.currentPart);
            const difficulty = currentPartData.difficulty || 3;

            // –õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∑–∞–¥–∞—á–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            if (difficulty === 5) {
                a = Math.floor(Math.random() * 20) + 10;
                b = Math.floor(Math.random() * 9) + 2;
                operator = Math.random() < 0.5 ? '*' : '+';
                if (operator === '*' && b === 1) b = 2; 
                if (operator === '+' && a > 30) a = 30;
            } else if (difficulty === 4) {
                a = Math.floor(Math.random() * 50) + 5;
                b = Math.floor(Math.random() * 20) + 5;
                operator = Math.random() < 0.6 ? '+' : '-';
                if (operator === '-' && a < b) [a, b] = [b, a]; 
            } else {
                a = Math.floor(Math.random() * 10) + 1;
                b = Math.floor(Math.random() * 10) + 1;
                operator = '+';
            }

            problem = `${a} ${operator} ${b}`;

            // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ (–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ eval)
            switch (operator) {
                case '+':
                    correctAnswer = a + b;
                    break;
                case '-':
                    correctAnswer = a - b;
                    break;
                case '*':
                    correctAnswer = a * b;
                    break;
                default:
                    correctAnswer = a + b; 
            }

            document.getElementById('math-problem').textContent = problem + ' = ?';
            gameState.mathAnswer = correctAnswer;
        }

        function submitMathAnswer() {
            if (!gameState.mechanicActive) return;
            
            const answer = document.getElementById('math-answer').value;
            document.getElementById('math-answer').value = ''; // –°–±—Ä–æ—Å –ø–æ–ª—è –≤–≤–æ–¥–∞

            if (parseInt(answer) === gameState.mathAnswer) {
                gameState.mathCurrent++;
                showAchievementNotification("–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è +1. –£—Å–ø–µ—à–Ω–æ.");
                document.getElementById('math-required-count').textContent = `${gameState.mathCurrent} / ${gameState.mathRequired}`;
                
                if (gameState.mathCurrent >= gameState.mathRequired) {
                    finishMechanic('math', true);
                } else {
                    generateMathProblem(); // –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
                }
            } else {
                showAchievementNotification("–û—à–∏–±–∫–∞ –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏. –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.");
                // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —Ä–∞—É–Ω–¥–µ
                gameState.mathCurrent = 0;
                document.getElementById('math-required-count').textContent = `${gameState.mathCurrent} / ${gameState.mathRequired}`;
                generateMathProblem();
            }
        }

        // --- 4. Coordinate Hack ---
        function startCoordinateHack() {
            document.getElementById('coordinate-hack-container').classList.remove('hidden');
            document.getElementById('coordinate-input').value = '';
        }

        function submitCoordinateHack() {
            if (!gameState.mechanicActive) return;
            
            const code = document.getElementById('coordinate-input').value;
            
            // –ö–æ–¥ 4242 –±–µ—Ä–µ—Ç—Å—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ (–ß–∞—Å—Ç—å 19)
            if (code === '4242') {
                finishMechanic('coordinate', true);
            } else {
                showAchievementNotification("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥-–ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!");
            }
        }

        // --- 5. Sequence Hack (–ù–û–í–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê) ---
        function startSequenceHack(difficulty) {
            document.getElementById('sequence-hack-container').classList.remove('hidden');
            gameState.sequenceRequired = difficulty;
            gameState.sequenceCurrent = 0;
            document.getElementById('sequence-required-count').textContent = `${gameState.sequenceCurrent} / ${gameState.sequenceRequired}`;
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            if (!gameState.sequenceListenerActive) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture: true, —á—Ç–æ–±—ã —Å–æ–±—ã—Ç–∏–µ –Ω–µ –ø–æ–ø–∞–ª–æ –≤ –¥—Ä—É–≥–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, input)
                document.addEventListener('keydown', handleSequenceInput, true); 
                gameState.sequenceListenerActive = true;
            }

            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
            document.querySelectorAll('#sequence-buttons button').forEach(button => {
                button.onclick = () => handleSequenceClick(button.dataset.key);
            });

            generateSequenceChallenge();
        }

        function generateSequenceChallenge() {
            gameState.sequenceGoal = [];
            gameState.sequencePlayer = [];
            const length = gameState.sequenceCurrent + 3; // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–ª–∏–Ω–Ω–µ–µ
            const keys = Object.keys(SEQUENCE_EMOJIS);

            for (let i = 0; i < length; i++) {
                gameState.sequenceGoal.push(keys[Math.floor(Math.random() * keys.length)]);
            }

            const display = document.getElementById('sequence-display');
            display.textContent = '–°–º–æ—Ç—Ä–∏—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ...';

            // –ú–∏–≥–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            let i = 0;
            const interval = setInterval(() => {
                if (i < gameState.sequenceGoal.length) {
                    const key = gameState.sequenceGoal[i];
                    display.textContent = SEQUENCE_EMOJIS[key];
                    i++;
                } else {
                    clearInterval(interval);
                    display.textContent = '–í–∞—à —Ö–æ–¥:';
                }
            }, 500);
        }

        function handleSequenceClick(key) {
            // –≠–º—É–ª—è—Ü–∏—è keydown –¥–ª—è –∫–Ω–æ–ø–æ–∫
            handleSequenceInput({ key: key, target: document.body });
        }
        
        function handleSequenceInput(event) {
            if (!gameState.mechanicActive || document.getElementById('sequence-hack-container').classList.contains('hidden')) return;

            const validKeys = Object.keys(SEQUENCE_EMOJIS);
            if (!validKeys.includes(event.key)) return;

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ —Å—Ç—Ä–µ–ª–æ–∫
            event.preventDefault();

            gameState.sequencePlayer.push(event.key);
            const display = document.getElementById('sequence-display');
            display.textContent = gameState.sequencePlayer.map(k => SEQUENCE_EMOJIS[k]).join(' ');

            const currentLength = gameState.sequencePlayer.length;

            if (gameState.sequencePlayer[currentLength - 1] !== gameState.sequenceGoal[currentLength - 1]) {
                showAchievementNotification("–°–±–æ–π –†–µ—Ñ–ª–µ–∫—Å–∞! –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞.");
                gameState.sequencePlayer = [];
                setTimeout(() => display.textContent = '–í–∞—à —Ö–æ–¥:', 500);
                return;
            }

            if (currentLength === gameState.sequenceGoal.length) {
                gameState.sequenceCurrent++;
                showAchievementNotification("–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–∞. –ü—Ä–æ–≥—Ä–µ—Å—Å +1.");
                document.getElementById('sequence-required-count').textContent = `${gameState.sequenceCurrent} / ${gameState.sequenceRequired}`;

                if (gameState.sequenceCurrent >= gameState.sequenceRequired) {
                    // –£–¥–∞–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    document.removeEventListener('keydown', handleSequenceInput, true);
                    gameState.sequenceListenerActive = false;
                    finishMechanic('sequence', true);
                } else {
                    setTimeout(generateSequenceChallenge, 1000); // –°–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥
                }
            }
        }

        // --- 6. Filter Hack (–ù–û–í–ê–Ø –ú–ï–•–ê–ù–ò–ö–ê) ---
        function startFilterHack(difficulty) {
            document.getElementById('filter-hack-container').classList.remove('hidden');
            gameState.filterRequired = difficulty;
            gameState.filterCurrent = 0;
            document.getElementById('filter-required-count').textContent = `${gameState.filterCurrent} / ${gameState.filterRequired}`;
            generateFilterChallenge();
        }

        function generateFilterChallenge() {
            const optionsContainer = document.getElementById('filter-options');
            optionsContainer.innerHTML = '';
            
            // –í—ã–±–∏—Ä–∞–µ–º –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π –∏ —Ü–µ–ª–µ–≤–æ–π —ç–º–æ–¥–∑–∏
            const allEmojis = [...EMOJIS].sort(() => 0.5 - Math.random());
            const dominantEmoji = allEmojis[0];
            const targetEmoji = allEmojis[1]; 
            gameState.filterTargetEmoji = targetEmoji;

            let shuffledOptions = [];
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–µ —ç–º–æ–¥–∑–∏ (8-12 —Ä–∞–∑)
            const dominantCount = Math.floor(Math.random() * 5) + 8; // 8-12
            for (let i = 0; i < dominantCount; i++) {
                shuffledOptions.push(dominantEmoji);
            }
            // –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–ª–µ–≤—ã–µ —ç–º–æ–¥–∑–∏ (1-2 —Ä–∞–∑–∞)
            shuffledOptions.push(targetEmoji);
            if (Math.random() > 0.5) shuffledOptions.push(targetEmoji); // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä–æ–π —Ü–µ–ª–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —É—Å–ª–æ–∂–Ω–µ–Ω–∏—è

            // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º
            shuffledOptions = shuffledOptions.sort(() => 0.5 - Math.random());

            shuffledOptions.forEach(emoji => {
                const button = document.createElement('button');
                button.className = 'emoji-button';
                button.textContent = emoji;
                // –í—Å–µ –∫–Ω–æ–ø–∫–∏, –∫—Ä–æ–º–µ —Ü–µ–ª–µ–≤–æ–π, –≤–µ–¥—É—Ç –∫ –ø—Ä–æ–∏–≥—Ä—ã—à—É
                if (emoji === targetEmoji) {
                    // –¶–µ–ª–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞
                    button.onclick = () => handleFilterClick(emoji);
                } else {
                    // "–®—É–º–Ω—ã–µ" –∫–Ω–æ–ø–∫–∏
                    button.onclick = () => handleFilterClick(dominantEmoji); // –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –¥–æ–º–∏–Ω–∞–Ω—Ç–Ω—ã–π (–Ω–µ–≤–µ—Ä–Ω—ã–π) —Å–∏–≥–Ω–∞–ª
                }
                optionsContainer.appendChild(button);
            });
        }

        function handleFilterClick(emoji) {
            if (!gameState.mechanicActive) return;
            
            if (emoji === gameState.filterTargetEmoji) {
                gameState.filterCurrent++;
                showAchievementNotification("–ß–∏—Å—Ç—ã–π —Å–∏–≥–Ω–∞–ª –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω. –ü—Ä–æ–≥—Ä–µ—Å—Å +1.");
                if (gameState.filterCurrent >= gameState.filterRequired) {
                    finishMechanic('filter', true);
                } else {
                    document.getElementById('filter-required-count').textContent = `${gameState.filterCurrent} / ${gameState.filterRequired}`;
                    generateFilterChallenge();
                }
            } else {
                showAchievementNotification("–°–∏–≥–Ω–∞–ª –∑–∞–≥—Ä—è–∑–Ω–µ–Ω. –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.");
                gameState.filterCurrent = 0;
                document.getElementById('filter-required-count').textContent = `${gameState.filterCurrent} / ${gameState.filterRequired}`;
                generateFilterChallenge();
            }
        }


        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        window.onload = async function () {
            // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å—é–∂–µ—Ç–∞
            try {
                await loadStoryData();
            } catch (error) {
                return; // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, –µ—Å–ª–∏ —Å—é–∂–µ—Ç –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            }
            
            loadGameState();
            displayStoryPart(gameState.currentPart);
            updateUI();
        };
    </script>
</body>
</html>